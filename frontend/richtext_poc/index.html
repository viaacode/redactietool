<html>

  <head>

    <!-- Include stylesheet -->
    <link href="quill.snow.css" rel="stylesheet">

    <!-- just a little hack to have dutch menus -->
    <style>
        .wrapper-later-with-bulma{
          width: 500px;
          margin-left: auto;
          margin-right: auto;
          height: 15em;
        }

        .ql-snow .ql-picker.ql-header .ql-picker-label::before,
        .ql-snow .ql-picker.ql-header .ql-picker-item::before {
          content: 'Normaal';
        }
        .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="1"]::before,
        .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="1"]::before {
          content: 'Titel h1';
        }
        .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="2"]::before,
        .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="2"]::before {
          content: 'Titel h2';
        }
        .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="3"]::before,
        .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="3"]::before {
          content: 'Titel h3';
        }
    </style>


    <!-- Include the Quill library v1.3.6-->
    <script src="quill.js"></script>

    <!-- in case we want markup instead -->
    <script src="turndown.js"></script>

  </head>
  <body>


    
    <!-- Create the editor container -->
    <div class="wrapper-later-with-bulma">
      <h2>Het archief voor Onderwijs beschrijving</h2>

      <div id="redactietool-richtext-editor">
        <h1>Proof of concept richtext editor</h1>

        <p>Eerste paragraaf</p>

        <p>
          De <a href="https://quilljs.com/docs/quickstart/">quill editor</a> geeft vrij propere output.
        </p>
        <p>En met turndown npm library kunnen we ook opteren om er toch markdown van te maken (maar nog niet zeker of de reverse operatie daarmee werkt...)
        maar als poc kunnen we dus ook dat tonen...</p>

        <p>That's all folks!</p>

      </div>

      <br/>
      Editor output: <br/>
      <textarea id="onderwijs_beschrijving" rows="15" cols="70">
      </textarea>

      <br/><br/>
      Editor markdown output: <br/>
      <textarea id="onderwijs_markdown" rows="15" cols="70">
      </textarea>



      <p>
      So hooray we're done and can plug this straight into our metadata edit form. ... Euhm no, far from it.
      This is dangerous as hell. Not convinced? Read this and then you realize the implications of putting this into our metadata:

      <br/>
      <br/>
      Check out this puppy:
      <a href="https://github.com/showdownjs/showdown/wiki/Markdown's-XSS-Vulnerability-(and-how-to-mitigate-it)">XSS vulnerability in markdown</a>
      <br/>
      And this one too: <a href="https://www.codeproject.com/Articles/134024/HTML-and-JavaScript-Injection">javascript injection dangers</a>
      </p>
      <p>
      The same applies to html content and our mileage may vary on what we can allow/do here to mitigate it.
      Most likely a select few of whitelisted html tags and fully parsing + sanitizing on the backend is a must here...
      Just doing a simple regexp filter of &lt; and &gt; is something to consider but even that can be circumvented if you're not careful!
      </p>
      <p>
      So yes, doing this has a lot of implications. I've seen countless sites that just wing it, add the feature and only later realize the can of worms they've just opened:<br/>
      <a href="https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html">XSS attack vectors</a>
      </p>

    </div>

<script>
  function richtext_changed(){
    var editor_div = document.getElementById("redactietool-richtext-editor");
    if(editor_div){
      var html_content = editor_div.firstChild.innerHTML
      console.log("\neditor content:\n", html_content);
      
      var editor_form_target = document.getElementById("onderwijs_beschrijving");
      if(editor_form_target){
        editor_form_target.value = html_content;
      }

      var markdown_target = document.getElementById("onderwijs_markdown");
      if(markdown_target){
        var markdown = turndownService.turndown(html_content);
        markdown_target.value = markdown;
      }
    }
  }


  var turndownService = new TurndownService();
  var quill = new Quill('#redactietool-richtext-editor', {
    modules: {
      toolbar: [
        [{ header: [2, false] }],
        ['bold', 'italic', 'underline'],
        ['link']
        //['image', 'code-block'] //no images and no files!
      ]
    },
    placeholder: 'Het archief voor Onderwijs beschrijving',
    theme: 'snow'  // or 'bubble'
  });

  
  quill.on('editor-change', function(eventName, ...args) {
    //  if (eventName === 'text-change') {
    //    // args[0] will be delta
    //  } else if (eventName === 'selection-change') {
    //    // args[0] will be old range
    //  }
    //  var plaintext = quill.getText();
    //  var contents = quill.getContents();
    //  console.log("TEXT=", plaintext);
    //  console.log("CONTENT=", contents);

    richtext_changed(); 
  });

  document.addEventListener('DOMContentLoaded', () => {
      richtext_changed();
  });

</script>

  </body>
</html>

